<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda - TrackMyVend</title>

  <!-- Supabase & Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.8.0/dist/umd/supabase.min.js"></script>

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #2345e1 0%, #667eea 100%);
      color: white;
      padding: 1rem 0;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 30px rgba(0,0,0,0.1);
      transform: translateZ(0);
      will-change: transform;
    }

    .nav-container {
      max-width: auto;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2rem;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: bold;
      color: white;
      text-decoration: none;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .nav-menu {
      display: flex;
      list-style: none;
      gap: 1.5rem;
      align-items: center;
    }

    .nav-menu a {
      color: white;
      text-decoration: none;
      transition: all 0.3s ease;
      padding: 0.7rem 1.2rem;
      border-radius: 25px;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .nav-menu a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .nav-menu a:hover::before {
      left: 100%;
    }

    .nav-menu a:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .nav-menu a.active {
      background: rgba(255,255,255,0.3);
      font-weight: bold;
    }

    /* Main container */
    .main-container {
      margin-top: 80px;
      min-height: calc(100vh - 80px);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 2rem 0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* Cards styling */
    .modern-card {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
      transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .modern-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .modern-card:hover {
      transform: translateY(-5px) translateZ(0);
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
      border-color: #667eea;
    }

    /* Calendar styles */
    .calendar-container {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .calendar-nav {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .calendar-nav:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .calendar-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2345e1;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }

    .calendar-day-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 1rem;
      text-align: center;
      font-weight: 600;
    }

    .calendar-day {
      background: white;
      padding: 1rem;
      min-height: 100px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .calendar-day:hover {
      background: #f8fafc;
      transform: scale(1.02);
    }

    .calendar-day.other-month {
      background: #f9fafb;
      color: #9ca3af;
    }

    .calendar-day.today {
      background: linear-gradient(135deg, #fef3c7, #fbbf24);
      font-weight: bold;
    }

    .calendar-day.has-events {
      background: linear-gradient(135deg, #dbeafe, #3b82f6);
      color: white;
    }

    .calendar-day.selected {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .day-number {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .event-indicator {
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
    }

    .event-preview {
      font-size: 0.75rem;
      background: rgba(255,255,255,0.2);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      margin-bottom: 0.2rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Event form */
    .event-form {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #374151;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Buttons */
    .modern-button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transform: translateZ(0);
    }

    .modern-button:hover {
      transform: translateY(-2px) translateZ(0);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .modern-button.success {
      background: linear-gradient(45deg, #10b981, #059669);
    }

    .modern-button.danger {
      background: linear-gradient(45deg, #ef4444, #dc2626);
    }

    .modern-button.secondary {
      background: linear-gradient(45deg, #6b7280, #4b5563);
    }

    /* Event list */
    .events-list {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }

    .event-item {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border-left: 4px solid #667eea;
      transition: all 0.3s ease;
    }

    .event-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .event-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .event-date {
      color: #6b7280;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .event-description {
      color: #374151;
      line-height: 1.5;
    }

    .event-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      border-radius: 8px;
    }

    /* Priority colors */
    .priority-alta { border-left-color: #ef4444; }
    .priority-media { border-left-color: #f59e0b; }
    .priority-baja { border-left-color: #10b981; }

    /* Section titles */
    .section-title {
      font-size: 2rem;
      font-weight: bold;
      color: #2345e1;
      margin-bottom: 1.5rem;
      text-align: center;
      position: relative;
      padding-bottom: 0.5rem;
    }

    .section-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .nav-menu {
        display: none;
      }
      
      .container {
        padding: 0 1rem;
      }

      .calendar-day {
        min-height: 80px;
        padding: 0.5rem;
      }

      .calendar-header {
        flex-direction: column;
        gap: 1rem;
      }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="nav-container">
      <a href="#" class="logo"> TrackMyVend</a>
      <nav>
        <ul class="nav-menu">
          <li><a href="/dashboard.html">ğŸ“Š Panel</a></li>
          <li><a href="/reportes.html">ğŸ“ˆ Reportes</a></li>
          <li><a href="/subscripcion.html">ğŸ’³ Suscripcion</a></li>
          <li><a href="/maquinas.html">ğŸ”§ Mis MÃ¡quinas</a></li>
          <li><a href="/agenda.html" class="active">ğŸ“… Agenda</a></li>
          <li><a href="#" id="btnLogout">ğŸšª Cerrar SesiÃ³n</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="main-container">
    <div class="container">

      <!-- Quick Add Event -->
      <div class="event-form">
        <h2 class="section-title">â• Agregar Evento RÃ¡pido</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="form-group">
            <label class="form-label">ğŸ“… Fecha</label>
            <input type="date" id="quickDate" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label">ğŸ“ TÃ­tulo</label>
            <input type="text" id="quickTitle" class="form-input" placeholder="Ej: Mantenimiento mÃ¡quina 1" />
          </div>
          <div class="form-group">
            <label class="form-label">âš¡ Prioridad</label>
            <select id="quickPriority" class="form-select">
              <option value="baja">ğŸŸ¢ Baja</option>
              <option value="media">ğŸŸ¡ Media</option>
              <option value="alta">ğŸ”´ Alta</option>
            </select>
          </div>
          <div class="form-group flex items-end">
            <button id="btnQuickAdd" class="modern-button success w-full">
              âœ… Agregar
            </button>
          </div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="calendar-container">
        <div class="calendar-header">
          <button id="prevMonth" class="calendar-nav">â¬…ï¸ Anterior</button>
          <h2 id="calendarTitle" class="calendar-title"></h2>
          <button id="nextMonth" class="calendar-nav">Siguiente â¡ï¸</button>
        </div>
        <div class="calendar-grid" id="calendar">
          <!-- Calendar will be generated here -->
        </div>
      </div>

      <!-- Events for Selected Date -->
      <div id="selectedDateEvents" class="events-list hidden">
        <h2 class="section-title" id="selectedDateTitle">ğŸ“‹ Eventos del DÃ­a</h2>
        <div id="eventsList"></div>
      </div>

      <!-- All Events -->
      <div class="events-list">
        <h2 class="section-title">ğŸ“š Todos los Eventos</h2>
        <div class="mb-4 flex gap-2 flex-wrap">
          <button id="filterAll" class="modern-button active">Todos</button>
          <button id="filterAlta" class="modern-button danger">ğŸ”´ Alta</button>
          <button id="filterMedia" class="modern-button" style="background: linear-gradient(45deg, #f59e0b, #d97706);">ğŸŸ¡ Media</button>
          <button id="filterBaja" class="modern-button success">ğŸŸ¢ Baja</button>
        </div>
        <div id="allEventsList"></div>
      </div>

    </div>
  </div>

  <!-- Event Detail Modal -->
  <div id="eventModal" class="modal hidden">
    <div class="modal-content">
      <h3 class="text-xl font-bold mb-4 text-blue-600">ğŸ“ Detalles del Evento</h3>
      <form id="eventForm">
        <div class="form-group">
          <label class="form-label">ğŸ“… Fecha</label>
          <input type="date" id="eventDate" class="form-input" required />
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ• Hora (opcional)</label>
          <input type="time" id="eventTime" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“ TÃ­tulo</label>
          <input type="text" id="eventTitle" class="form-input" placeholder="TÃ­tulo del evento" required />
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“„ DescripciÃ³n</label>
          <textarea id="eventDescription" class="form-textarea" placeholder="DescripciÃ³n detallada del evento"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ·ï¸ CategorÃ­a</label>
          <select id="eventCategory" class="form-select">
            <option value="mantenimiento">ğŸ”§ Mantenimiento</option>
            <option value="visita">ğŸš¶ Visita</option>
            <option value="reunion">ğŸ‘¥ ReuniÃ³n</option>
            <option value="recordatorio">â° Recordatorio</option>
            <option value="otro">ğŸ“Œ Otro</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">âš¡ Prioridad</label>
          <select id="eventPriority" class="form-select">
            <option value="baja">ğŸŸ¢ Baja</option>
            <option value="media">ğŸŸ¡ Media</option>
            <option value="alta">ğŸ”´ Alta</option>
          </select>
        </div>
        <div class="flex gap-2 mt-6">
          <button type="submit" class="modern-button success flex-1">ğŸ’¾ Guardar</button>
          <button type="button" id="btnDeleteEvent" class="modern-button danger hidden">ğŸ—‘ï¸ Eliminar</button>
          <button type="button" id="btnCancelEvent" class="modern-button secondary">âœ–ï¸ Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Event management system
    class AgendaManager {
      constructor() {
        this.events = JSON.parse(localStorage.getItem('trackMyVendEvents') || '[]');
        this.currentDate = new Date();
        this.selectedDate = null;
        this.editingEventId = null;
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.renderCalendar();
        this.renderAllEvents();
        this.setTodayAsDefault();
      }

      setupEventListeners() {
        // Calendar navigation
        document.getElementById('prevMonth').addEventListener('click', () => {
          this.currentDate.setMonth(this.currentDate.getMonth() - 1);
          this.renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
          this.currentDate.setMonth(this.currentDate.getMonth() + 1);
          this.renderCalendar();
        });

        // Quick add event
        document.getElementById('btnQuickAdd').addEventListener('click', () => {
          this.quickAddEvent();
        });

        // Event form
        document.getElementById('eventForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.saveEvent();
        });

        document.getElementById('btnCancelEvent').addEventListener('click', () => {
          this.closeModal();
        });

        document.getElementById('btnDeleteEvent').addEventListener('click', () => {
          this.deleteEvent();
        });

        // Filter buttons
        document.getElementById('filterAll').addEventListener('click', () => this.filterEvents('all'));
        document.getElementById('filterAlta').addEventListener('click', () => this.filterEvents('alta'));
        document.getElementById('filterMedia').addEventListener('click', () => this.filterEvents('media'));
        document.getElementById('filterBaja').addEventListener('click', () => this.filterEvents('baja'));

        // Quick date set to today
        document.getElementById('quickDate').value = new Date().toISOString().split('T')[0];
      }

      setTodayAsDefault() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('quickDate').value = today;
      }

      renderCalendar() {
        const calendar = document.getElementById('calendar');
        const calendarTitle = document.getElementById('calendarTitle');
        
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        calendarTitle.textContent = this.currentDate.toLocaleDateString('es-MX', { 
          month: 'long', 
          year: 'numeric' 
        }).toUpperCase();

        // Clear calendar
        calendar.innerHTML = '';

        // Day headers
        const dayHeaders = ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'];
        dayHeaders.forEach(day => {
          const dayHeader = document.createElement('div');
          dayHeader.className = 'calendar-day-header';
          dayHeader.textContent = day;
          calendar.appendChild(dayHeader);
        });

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDay = firstDay.getDay();

        // Previous month days
        const prevMonth = new Date(year, month, 0);
        const daysFromPrevMonth = startDay;
        
        for (let i = daysFromPrevMonth; i > 0; i--) {
          const day = prevMonth.getDate() - i + 1;
          const dayDiv = this.createDayElement(day, true, new Date(year, month - 1, day));
          calendar.appendChild(dayDiv);
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
          const currentDay = new Date(year, month, day);
          const dayDiv = this.createDayElement(day, false, currentDay);
          calendar.appendChild(dayDiv);
        }

        // Next month days
        const totalCells = calendar.children.length - 7; // Subtract header cells
        const remainingCells = 42 - totalCells; // 6 rows * 7 days
        
        for (let day = 1; day <= remainingCells; day++) {
          const dayDiv = this.createDayElement(day, true, new Date(year, month + 1, day));
          calendar.appendChild(dayDiv);
        }
      }

      createDayElement(day, isOtherMonth, date) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        if (isOtherMonth) {
          dayDiv.classList.add('other-month');
        }

        // Check if it's today
        const today = new Date();
        if (date.toDateString() === today.toDateString()) {
          dayDiv.classList.add('today');
        }

        // Check if it's selected
        if (this.selectedDate && date.toDateString() === this.selectedDate.toDateString()) {
          dayDiv.classList.add('selected');
        }

        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        dayDiv.appendChild(dayNumber);

        // Get events for this day
        const dateStr = date.toISOString().split('T')[0];
        const dayEvents = this.events.filter(event => event.date === dateStr);

        if (dayEvents.length > 0) {
          dayDiv.classList.add('has-events');
          
          // Add event indicator
          const indicator = document.createElement('div');
          indicator.className = 'event-indicator';
          dayDiv.appendChild(indicator);

          // Add event previews (max 2)
          dayEvents.slice(0, 2).forEach(event => {
            const preview = document.createElement('div');
            preview.className = 'event-preview';
            preview.textContent = event.title;
            dayDiv.appendChild(preview);
          });

          if (dayEvents.length > 2) {
            const more = document.createElement('div');
            more.className = 'event-preview';
            more.textContent = `+${dayEvents.length - 2} mÃ¡s`;
            dayDiv.appendChild(more);
          }
        }

        // Click handler
        dayDiv.addEventListener('click', () => {
          // Remove previous selection
          document.querySelectorAll('.calendar-day.selected').forEach(el => {
            el.classList.remove('selected');
          });
          
          // Add selection to clicked day
          dayDiv.classList.add('selected');
          this.selectedDate = date;
          this.showSelectedDateEvents(date);
        });

        // Double click to add event
        dayDiv.addEventListener('dblclick', () => {
          this.openModal(date);
        });

        return dayDiv;
      }

      showSelectedDateEvents(date) {
        const selectedSection = document.getElementById('selectedDateEvents');
        const selectedTitle = document.getElementById('selectedDateTitle');
        const eventsList = document.getElementById('eventsList');
        
        const dateStr = date.toISOString().split('T')[0];
        const dayEvents = this.events.filter(event => event.date === dateStr);
        
        selectedTitle.textContent = `ğŸ“‹ Eventos del ${date.toLocaleDateString('es-MX', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}`;

        if (dayEvents.length === 0) {
          eventsList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <p class="text-lg mb-4">ğŸ“… No hay eventos para este dÃ­a</p>
              <button class="modern-button" onclick="agendaManager.openModal(new Date('${dateStr}'))">
                â• Agregar Evento
              </button>
            </div>
          `;
        } else {
          eventsList.innerHTML = dayEvents.map(event => this.renderEventItem(event)).join('');
        }
        
        selectedSection.classList.remove('hidden');
      }

      quickAddEvent() {
        const date = document.getElementById('quickDate').value;
        const title = document.getElementById('quickTitle').value.trim();
        const priority = document.getElementById('quickPriority').value;

        if (!date || !title) {
          alert('Por favor completa la fecha y el tÃ­tulo del evento');
          return;
        }

        const event = {
          id: Date.now().toString(),
          date: date,
          time: '',
          title: title,
          description: '',
          category: 'recordatorio',
          priority: priority,
          createdAt: new Date().toISOString()
        };

        this.events.push(event);
        this.saveEvents();
        this.renderCalendar();
        this.renderAllEvents();

        // Clear form
        document.getElementById('quickTitle').value = '';
        document.getElementById('quickPriority').value = 'baja';

        // Show success message
        this.showNotification('âœ… Evento agregado exitosamente');
      }

      openModal(date = null, event = null) {
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('eventForm');
        const deleteBtn = document.getElementById('btnDeleteEvent');

        // Reset form
        form.reset();
        this.editingEventId = null;

        if (event) {
          // Editing existing event
          this.editingEventId = event.id;
          document.getElementById('eventDate').value = event.date;
