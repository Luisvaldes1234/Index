<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - TrackMyVend</title>
  <!-- Load scripts with proper order -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.8.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <!-- Environment variables - will be injected at build time -->
  <script>
    window.env = {
      NEXT_PUBLIC_SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrdW91eGxsZXJmam5pYmp0bGtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzQ5ODIsImV4cCI6MjA2MTY1MDk4Mn0.ofmYTPFMfRrHOI2YQxjIb50uB_uO8UaHuiQ0T1kbv2U',
      SUPABASE_URL: 'https://ikuouxllerjnibjtkll.supabase.co'
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    /* Add loading animation */
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .dark .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: #09f;
    }
    
    /* Fix chart sizing */
    canvas {
      width: 100% !important;
      height: 300px !important;
    }
    
    /* Improve responsiveness */
    @media (max-width: 640px) {
      .date-filter {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .date-filter > * {
        margin-bottom: 0.5rem;
      }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100">
  <!-- NAV -->
  <nav class="bg-gray-900 text-white px-4 py-3 shadow-md flex gap-6 text-sm md:text-base">
    <a href="/dashboard.html" class="hover:underline font-semibold">Dashboard</a>
    <a href="/reportes.html" class="hover:underline">Reportes</a>
    <a href="/subscripcion.html" class="hover:underline">Subscripción</a>
    <a href="/maquinas.html" class="hover:underline">Mis Máquinas</a>
    <a href="#" id="btnLogout" class="hover:underline ml-auto">Cerrar Sesión</a>
  </nav>
  
  <div class="container mx-auto px-4 py-6 space-y-8">
    <!-- Loading indicator that shows before data is loaded -->
    <div id="loading" class="flex justify-center py-8">
      <div class="loading-spinner"></div>
    </div>
    
    <!-- FILTROS Y EXPORTACIÓN -->
    <div class="mb-6 space-y-4">
      <div class="flex gap-4 items-center flex-wrap date-filter">
        <label class="text-sm font-medium">Desde:</label>
        <input type="date" id="fechaDesde" class="px-3 py-1 border rounded dark:bg-gray-800 dark:border-gray-700" />
        <label class="text-sm font-medium">Hasta:</label>
        <input type="date" id="fechaHasta" class="px-3 py-1 border rounded dark:bg-gray-800 dark:border-gray-700" />
        <label class="text-sm font-medium">Máquina:</label>
        <select id="filtroMaquinaCSV" class="px-3 py-1 border rounded dark:bg-gray-800 dark:border-gray-700">
          <option value="">Todas</option>
        </select>
        <button id="btnDescargarCSV" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 transition">
          Descargar CSV
        </button>
      </div>
    </div>
    
    <!-- TARJETAS RESUMEN -->
    <div id="resumen" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
      <!-- Data will be populated here -->
    </div>
    
    <!-- GRAFICAS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">Tendencia de ventas por hora</h2>
        <canvas id="graficaHoras"></canvas>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">Ventas por día</h2>
        <canvas id="graficaDias"></canvas>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">Volumen vendido</h2>
        <canvas id="graficaVolumen"></canvas>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">Rendimiento por máquina</h2>
        <canvas id="graficaMaquinas"></canvas>
      </div>
    </div>
  </div>
  
  <!-- Error Modal -->
  <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
      <h3 class="text-lg font-bold mb-2">Error</h3>
      <p id="errorMessage" class="mb-4">Mensaje de error</p>
      <div class="flex justify-end">
        <button onclick="document.getElementById('errorModal').classList.add('hidden')" 
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- Debug Info Modal -->
  <div id="debugModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
      <h3 class="text-lg font-bold mb-2">Información de Depuración</h3>
      <pre id="debugMessage" class="bg-gray-100 dark:bg-gray-700 p-3 rounded text-xs overflow-auto max-h-96 mb-4"></pre>
      <div class="flex justify-end">
        <button onclick="document.getElementById('debugModal').classList.add('hidden')" 
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <script>
    // Show loading indicator
    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
    }
    
    // Hide loading indicator
    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }
    
    // Show error modal with message
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorModal').classList.remove('hidden');
      console.error(message);
    }
    
    // Debug function - helpful for troubleshooting
    function showDebug(obj) {
      document.getElementById('debugMessage').textContent = JSON.stringify(obj, null, 2);
      document.getElementById('debugModal').classList.remove('hidden');
      console.log(obj);
    }
    
    // Override default alert with custom modal
    window.originalAlert = window.alert;
    window.alert = function(message) {
      showError(message);
    };
    
    // Hide loading when page is fully loaded
    window.addEventListener('load', function() {
      hideLoading();
    });

    // Variables globales
    let supabaseClient;
    let usuario;
    let maquinas = [];
    let ventas = [];

    // Configuración de fechas por defecto
    const hoy = new Date();
    const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

    // Inicialización segura de Supabase
    function inicializarSupabase() {
      // Verificar que window.env existe y tiene la clave
      if (!window.env || !window.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {
        console.error("Missing Supabase API key");
        showError("Error: No se ha encontrado la clave API de Supabase. Por favor, contacte al soporte técnico.");
        return false;
      }

      try {
        // Crear cliente de Supabase correctamente - usando el objeto global supabase
        supabaseClient = supabase.createClient(
          window.env.SUPABASE_URL || 'https://ikuouxllerjnibjtkll.supabase.co',
          window.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
        );
        console.log("Supabase inicializado correctamente");
        return true;
      } catch (error) {
        console.error("Error al inicializar Supabase:", error);
        showError("Error al conectar con la base de datos. Por favor, intente más tarde.");
        return false;
      }
    }

    // Verificar la sesión del usuario
    async function verificarSesion() {
      try {
        // Primero asegurarse que Supabase está inicializado
        if (!inicializarSupabase()) {
          return false;
        }

        const { data, error } = await supabaseClient.auth.getSession();
        
        if (error) {
          console.error("Error al verificar sesión:", error);
          // No redireccionamos inmediatamente, mostramos el error primero
          showError("Error al verificar tu sesión: " + error.message);
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 3000);
          return false;
        }
        
        if (!data.session) {
          console.log("No hay sesión activa");
          // Mostramos un mensaje antes de redirigir
          showError("No hay sesión activa. Redirigiendo al login...");
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 3000);
          return false;
        }
        
        usuario = data.session.user;
        console.log("Usuario autenticado:", usuario.email);
        
        // Configurar botón de logout
        const btnLogout = document.getElementById('btnLogout');
        if (btnLogout) {
          btnLogout.addEventListener('click', async function(e) {
            e.preventDefault();
            await cerrarSesion();
          });
        }
        
        return true;
      } catch (error) {
        console.error("Error inesperado al verificar sesión:", error);
        showError("Error inesperado al verificar la sesión: " + (error.message || 'Desconocido'));
        return false;
      }
    }

    // Cerrar sesión de usuario
    async function cerrarSesion() {
      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        window.location.href = '/login.html';
      } catch (error) {
        showError("Error al cerrar sesión: " + error.message);
      }
    }

    // Obtener datos de las máquinas
    async function obtenerMaquinas() {
      try {
        if (!usuario || !usuario.id) {
          console.error("No hay usuario autenticado");
          return false;
        }
        
        const { data, error } = await supabaseClient
          .from('maquinas')
          .select('*')
          .eq('id_usuario', usuario.id);
        
        if (error) {
          throw error;
        }
        
        maquinas = data || [];
        console.log("Máquinas obtenidas:", maquinas.length);
        
        // Llenar el selector de máquinas
        const selectMaquina = document.getElementById('filtroMaquinaCSV');
        if (selectMaquina) {
          selectMaquina.innerHTML = '<option value="">Todas</option>';
          
          maquinas.forEach(maquina => {
            const option = document.createElement('option');
            option.value = maquina.id;
            option.textContent = maquina.nombre || `Máquina ${maquina.id}`;
            selectMaquina.appendChild(option);
          });
        }
        
        // Si no hay máquinas, mostrar un mensaje
        if (maquinas.length === 0) {
          showError("No tienes máquinas registradas. Ve a la sección 'Mis Máquinas' para agregar una.");
        }
        
        return true;
      } catch (error) {
        console.error("Error al obtener máquinas:", error);
        showError("Error al cargar las máquinas: " + error.message);
        return false;
      }
    }

    // Obtener datos de ventas
    async function obtenerVentas() {
      try {
        if (!usuario || !usuario.id) {
          console.error("No hay usuario autenticado");
          return false;
        }
        
        const fechaDesde = document.getElementById('fechaDesde').value;
        const fechaHasta = document.getElementById('fechaHasta').value;
        
        if (!fechaDesde || !fechaHasta) {
          showError("Por favor, selecciona el rango de fechas");
          return false;
        }
        
        // Añadir un día a fechaHasta para incluir el día seleccionado completo
        const fechaHastaObj = new Date(fechaHasta);
        fechaHastaObj.setDate(fechaHastaObj.getDate() + 1);
        const fechaHastaAjustada = fechaHastaObj.toISOString().split('T')[0];
        
        console.log(`Obteniendo ventas desde ${fechaDesde} hasta ${fechaHastaAjustada}`);
        
        let query = supabaseClient
          .from('ventas')
          .select(`
            *,
            maquinas (
              nombre,
              ubicacion
            )
          `)
          .eq('id_usuario', usuario.id)
          .gte('fecha', fechaDesde)
          .lt('fecha', fechaHastaAjustada)
          .order('fecha', { ascending: false });
        
        const { data, error } = await query;
        
        if (error) {
          throw error;
        }
        
        ventas = data || [];
        console.log("Ventas obtenidas:", ventas.length);
        
        // Si no hay ventas, mostrar estado vacío
        if (ventas.length === 0) {
          document.getElementById('resumen').innerHTML = `
            <div class="col-span-full bg-white dark:bg-gray-800 p-6 rounded-lg shadow text-center">
              <h3 class="text-xl font-bold mb-2">No hay datos para este período</h3>
              <p class="text-gray-500 dark:text-gray-400">Prueba con otro rango de fechas o agrega nuevas ventas.</p>
            </div>
          `;
        }
        
        return true;
      } catch (error) {
        console.error("Error al obtener ventas:", error);
        showError("Error al cargar los datos de ventas: " + error.message);
        return false;
      }
    }

    // Actualizar el dashboard
    async function actualizarDashboard() {
      showLoading();
      
      try {
        const sesionValida = await verificarSesion();
        if (!sesionValida) {
          hideLoading();
          return;
        }
        
        const maquinasObtenidas = await obtenerMaquinas();
        if (!maquinasObtenidas) {
          hideLoading();
          return;
        }
        
        const ventasObtenidas = await obtenerVentas();
        if (!ventasObtenidas) {
          hideLoading();
          return;
        }
        
        // Solo actualizar gráficas si hay datos
        if (ventas.length > 0) {
          actualizarTarjetasResumen();
          actualizarGraficas();
        }
      } catch (error) {
        console.error("Error al actualizar dashboard:", error);
        showError("Error al actualizar el dashboard: " + (error.message || "Desconocido"));
      } finally {
        hideLoading();
      }
    }

    // Actualizar tarjetas de resumen
    function actualizarTarjetasResumen() {
      try {
        // Calcular métricas
        const totalVentas = ventas.reduce((sum, venta) => sum + (venta.importe || 0), 0);
        const totalUnidades = ventas.reduce((sum, venta) => sum + (venta.unidades || 0), 0);
        const ventasUnicas = new Set(ventas.map(v => v.id)).size;
        const promedioPorVenta = ventasUnicas > 0 ? totalVentas / ventasUnicas : 0;
        
        // Calcular ventas por día
        const fechaInicio = new Date(document.getElementById('fechaDesde').value);
        const fechaFin = new Date(document.getElementById('fechaHasta').value);
        const diasPeriodo = Math.max(1, Math.ceil((fechaFin - fechaInicio) / (1000 * 60 * 60 * 24)) + 1);
        const promedioVentasDiarias = diasPeriodo > 0 ? totalVentas / diasPeriodo : 0;
        
        // Actualizar HTML
        document.getElementById('resumen').innerHTML = `
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <h3 class="text-xl font-bold">$${totalVentas.toFixed(2)}</h3>
            <p class="text-gray-500 dark:text-gray-400">Ventas totales</p>
          </div>
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <h3 class="text-xl font-bold">${totalUnidades}</h3>
            <p class="text-gray-500 dark:text-gray-400">Unidades vendidas</p>
          </div>
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <h3 class="text-xl font-bold">${ventasUnicas}</h3>
            <p class="text-gray-500 dark:text-gray-400">Transacciones</p>
          </div>
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <h3 class="text-xl font-bold">$${promedioPorVenta.toFixed(2)}</h3>
            <p class="text-gray-500 dark:text-gray-400">Promedio por venta</p>
          </div>
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <h3 class="text-xl font-bold">$${promedioVentasDiarias.toFixed(2)}</h3>
            <p class="text-gray-500 dark:text-gray-400">Promedio diario</p>
          </div>
        `;
      } catch (error) {
        console.error("Error al actualizar tarjetas de resumen:", error);
        showError("Error al actualizar las métricas: " + error.message);
      }
    }

    // Actualizar gráficas
    function actualizarGraficas() {
      try {
        actualizarGraficaHoras();
        actualizarGraficaDias();
        actualizarGraficaVolumen();
        actualizarGraficaMaquinas();
      } catch (error) {
        console.error("Error al actualizar gráficas:", error);
        showError("Error al actualizar las gráficas: " + error.message);
      }
    }

    // Gráfica de ventas por hora
    function actualizarGraficaHoras() {
      try {
        // Agrupar ventas por hora
        const ventasPorHora = Array(24).fill(0);
        
        ventas.forEach(venta => {
          if (!venta.fecha) return;
          
          try {
            const fecha = new Date(venta.fecha);
            const hora = fecha.getHours();
            ventasPorHora[hora] += venta.importe || 0;
          } catch (e) {
            console.warn("Error al procesar fecha:", venta.fecha, e);
          }
        });
        
        // Etiquetas para las horas
        const etiquetas = Array(24).fill().map((_, i) => `${i}:00`);
        
        // Crear o actualizar gráfica
        const canvas = document.getElementById('graficaHoras');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        
        if (window.graficaHorasChart) {
          window.graficaHorasChart.destroy();
        }
        
        window.graficaHorasChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: etiquetas,
            datasets: [{
              label: 'Ventas ($)',
              data: ventasPorHora,
              borderColor: '#4c51bf',
              backgroundColor: 'rgba(76, 81, 191, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      } catch (error) {
        console.error("Error en gráfica de horas:", error);
      }
    }

    // Gráfica de ventas por día
    function actualizarGraficaDias() {
      try {
        // Agrupar ventas por día
        const ventasPorDia = {};
        
        ventas.forEach(venta => {
          if (!venta.fecha) return;
          
          try {
            const fecha = venta.fecha.split('T')[0];
            if (!ventasPorDia[fecha]) {
              ventasPorDia[fecha] = 0;
            }
            ventasPorDia[fecha] += venta.importe || 0;
          } catch (e) {
            console.warn("Error al procesar fecha para gráfica de días:", venta.fecha, e);
          }
        });
        
        // Convertir a arrays para la gráfica
        const fechas = Object.keys(ventasPorDia).sort();
        const importes = fechas.map(fecha => ventasPorDia[fecha]);
        
        // Crear o actualizar gráfica
        const canvas = document.getElementById('graficaDias');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        
        if (window.graficaDiasChart) {
          window.graficaDiasChart.destroy();
        }
        
        window.graficaDiasChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: fechas,
            datasets: [{
              label: 'Ventas ($)',
              data: importes,
              backgroundColor: '#38b2ac',
              borderColor: '#2c9b94',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      } catch (error) {
        console.error("Error en gráfica de días:", error);
      }
    }

    // Gráfica de volumen vendido
    function actualizarGraficaVolumen() {
      try {
        // Agrupar unidades por producto
        const unidadesPorProducto = {};
        
        ventas.forEach(venta => {
          const producto = venta.producto || 'Sin especificar';
          if (!unidadesPorProducto[producto]) {
            unidadesPorProducto[producto] = 0;
          }
          unidadesPorProducto[producto] += venta.unidades || 0;
        });
        
        // Convertir a arrays para la gráfica
        const productos = Object.keys(unidadesPorProducto);
        const unidades = productos.map(producto => unidadesPorProducto[producto]);
        
        // Crear o actualizar gráfica
        const canvas = document.getElementById('graficaVolumen');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        
        if (window.graficaVolumenChart) {
          window.graficaVolumenChart.destroy();
        }
        
        // Si no hay datos, mostrar mensaje
        if (productos.length === 0) {
          const parentElement = canvas.parentElement;
          if (parentElement) {
            const noDataMsg = document.createElement('div');
            noDataMsg.className = 'text-center py-16 text-gray-500 dark:text-gray-400';
            noDataMsg.innerHTML = 'No hay datos disponibles para este período';
            
            // Asegurarse de que no hay mensaje previo
            const existingMsg = parentElement.querySelector('.text-center.py-16');
            if (existingMsg) parentElement.removeChild(existingMsg);
            
            canvas.style.display = 'none';
            parentElement.appendChild(noDataMsg);
          }
          return;
        }
        
        // Si hay datos, eliminar cualquier mensaje de no datos
        const parentElement = canvas.parentElement;
        const existingMsg = parentElement?.querySelector('.text-center.py-16');
        if (existingMsg) parentElement.removeChild(existingMsg);
        canvas.style.display = 'block';
        
        window.graficaVolumenChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: productos,
            datasets: [{
              data: unidades,
              backgroundColor: [
                '#f56565', '#ed8936', '#ecc94b', '#48bb78', 
                '#38b2ac', '#4299e1', '#667eea', '#9f7aea',
                '#ed64a6', '#a0aec0'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right'
              }
            }
          }
        });
      } catch (error) {
        console.error("Error en gráfica de volumen:", error);
      }
    }

    // Gráfica de rendimiento por máquina
    function actualizarGraficaMaquinas() {
      try {
        // Agrupar ventas por máquina
        const ventasPorMaquina = {};
        
        ventas.forEach(venta => {
          const maquinaId = venta.id_maquina;
          const maquinaNombre = venta.maquinas ? venta.maquinas.nombre : null;
          const nombreMostrar = maquinaNombre || `Máquina ${maquinaId}`;
          
          if (!ventasPorMaquina[nombreMostrar]) {
            ventasPorMaquina[nombreMostrar] = 0;
          }
          ventasPorMaquina[nombreMostrar] += venta.importe || 0;
        });
        
        // Convertir a arrays para la gráfica
        const maquinas = Object.keys(ventasPorMaquina);
        const importes = maquinas.map(maquina => ventasPorMaquina[maquina]);
        
        // Crear o actualizar gráfica
        const canvas = document.getElementById('graficaMaquinas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        
        if (window.graficaMaquinasChart) {
          window.graficaMaquinasChart.destroy();
        }
        
        window.graficaMaquinasChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: maquinas,
            datasets: [{
              label: 'Ventas ($)',
              data: importes,
              backgroundColor: '#667eea',
              borderColor: '#5a67d8',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            },
            indexAxis: 'y' // Hacer que las barras sean horizontales
          }
        });
      } catch (error) {
        console.error("Error en gráfica de máquinas:", error);
      }
    }

    // Descargar CSV de ventas
    function descargarCSV() {
      try {
        if (!ventas || ventas.length === 0) {
          showError("No hay datos para exportar");
          return;
        }
        
        // Filtrar por máquina si es necesario
        const filtroMaquina = document.getElementById('filtroMaquinaCSV').value;
        let ventasFiltradas = ventas;
        
        if (filtroMaquina) {
          ventasFiltradas = ventas.filter(v => v.id_maquina == filtroMaquina);
        }
        
        if (ventasFiltradas.length === 0) {
          showError("No hay datos que cumplan con los filtros seleccionados");
          return;
        }
        
        // Preparar encabezados
        const encabezados = [
          'ID', 'Fecha', 'Hora', 'Máquina', 'Ubicación', 
          'Producto', 'Unidades', 'Importe'
        ];
        
        // Preparar filas de datos
        const filas = ventasFiltradas.map(venta => {
          const fecha = venta.fecha ? new Date(venta.fecha) : null;
          const fechaFormateada = fecha ? fecha.toLocaleDateString() : 'N/A';
          const horaFormateada = fecha ? fecha.toLocaleTimeString() : 'N/A';
          
          const maquinaNombre = venta.maquinas ? venta.maquinas.nombre : 'N/A';
          const ubicacion = venta.maquinas ? venta.maquinas.ubicacion : 'N/A';
          
          return [
            venta.id || '',
            fechaFormateada,
            horaFormateada,
            maquinaNombre,
            ubicacion,
            venta.producto || 'N/A',
            venta.unidades || 0,
            venta.importe || 0
          ];
        });
        
        // Crear contenido CSV
        let contenidoCSV = encabezados.join(',') + '\n';
        filas.forEach(fila => {
          // Escapar cualquier campo que contenga comas
          const filaEscapada = fila.map(campo => {
            if (String(campo).includes(',')) {
              return `"${campo}"`;
            }
            return campo;
          });
          contenidoCSV += filaEscapada.join(',') + '\n';
        });
        
        // Crear blob y enlace de descarga
        const blob = new Blob([contenidoCSV], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const fechaDesde = document.getElementById('fechaDesde').value;
        const fechaHasta = document.getElementById('fechaHasta').value;
        const nombreArchivo = `ventas_${fechaDesde}_a_${fechaHasta}.csv`;
        
        const link = document.createElement('a');
        link.href = url;
        link.download = nombreArchivo;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, 100);
        
      } catch (error) {
        console.error("Error al descargar CSV:", error);
        showError("Error al generar el archivo CSV: " + error.message);
      }
    }

    // Inicializar la aplicación cuando esté todo cargado
    document.addEventListener('DOMContentLoaded', function() {
      // Configurar fechas iniciales
      document.getElementById('fechaDesde').value = inicioMes.toISOString().split('T')[0];
      document.getElementById('fechaHasta').value = hoy.toISOString().split('T')[0];
      
      // Configurar eventos
      document.getElementById('fechaDesde').addEventListener('change', actualizarDashboard);
      document.getElementById('fechaHasta').addEventListener('change', actualizarDashboard);
      document.getElementById('btnDescargarCSV').addEventListener('click', descargarCSV);
      
      // Cargar datos iniciales
      actualizarDashboard();
    });
  </script>
</body>
</html>
