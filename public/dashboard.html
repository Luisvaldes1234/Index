<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Ventas por Volumen</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h1>Reporte de Ventas por Volumen</h1>

  <section id="ventasPorVolumen">
    <label for="periodo">Seleccionar período:</label>
    <select id="periodo">
      <option value="dia">Día</option>
      <option value="semana">Semana</option>
      <option value="mes">Mes</option>
      <option value="anio">Año</option>
    </select>

    <input type="date" id="fechaSeleccionada" />

    <button onclick="cargarVentas()">Ver Reporte</button>

    <div id="resultadoVentas"></div>

    <canvas id="graficoVentas" width="400" height="200"></canvas>

    <button onclick="descargarCSV()">Descargar CSV</button>
  </section>

  <script>
    const supabaseUrl = 'https://ikouxllerfjnibjtlklk.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrdW91eGxsZXJmam5pYmp0bGtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNzQ5ODIsImV4cCI6MjA2MTY1MDk4Mn0.ofmYTPFMfRrHOI2YQxjIb50uB_uO8UaHuiQ';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let resumenGlobal = {};

    async function cargarVentas() {
      const periodo = document.getElementById("periodo").value;
      const fecha = new Date(document.getElementById("fechaSeleccionada").value);
      let desde, hasta;

      if (periodo === "dia") {
        desde = new Date(fecha);
        hasta = new Date(fecha);
        hasta.setDate(hasta.getDate() + 1);
      } else if (periodo === "semana") {
        const dia = fecha.getDay();
        desde = new Date(fecha);
        desde.setDate(fecha.getDate() - dia);
        hasta = new Date(desde);
        hasta.setDate(hasta.getDate() + 7);
      } else if (periodo === "mes") {
        desde = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
        hasta = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 1);
      } else {
        desde = new Date(fecha.getFullYear(), 0, 1);
        hasta = new Date(fecha.getFullYear() + 1, 0, 1);
      }

      const { data, error } = await supabase
        .from('ventas')
        .select('*')
        .gte('fecha', desde.toISOString())
        .lt('fecha', hasta.toISOString());

      if (error) {
        console.error(error);
        alert("Error cargando datos.");
        return;
      }

      mostrarVentas(data);
    }

    function mostrarVentas(data) {
      const resumen = { '5': 0, '10': 0, '20': 0 };
      const conteo = { '5': 0, '10': 0, '20': 0 };

      data.forEach(v => {
        const litros = v.volumen_litros.toString();
        if (resumen[litros] !== undefined) {
          resumen[litros] += v.total;
          conteo[litros]++;
        }
      });

      resumenGlobal = { resumen, conteo };

      let html = '<h3>Resumen:</h3><ul>';
      for (let l of ['5', '10', '20']) {
        html += `<li>${l}L x ${resumen[l].toFixed(2)}$ (${conteo[l]} ventas)</li>`;
      }
      html += '</ul>';

      document.getElementById("resultadoVentas").innerHTML = html;
      generarGrafico(resumen, conteo);
    }

    function generarGrafico(resumen, conteo) {
      const ctx = document.getElementById('graficoVentas').getContext('2d');
      if (window.ventasChart) window.ventasChart.destroy();

      window.ventasChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['5L', '10L', '20L'],
          datasets: [{
            label: 'Ingresos por volumen ($)',
            data: [resumen['5'], resumen['10'], resumen['20']],
            backgroundColor: ['#4caf50', '#2196f3', '#ff9800']
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function descargarCSV() {
      const { resumen, conteo } = resumenGlobal;
      let csv = 'Volumen (L),Ventas ($),Cantidad de ventas\n';

      for (let l of ['5', '10', '20']) {
        csv += `${l},${resumen[l].toFixed(2)},${conteo[l]}\n`;
      }

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'ventas_por_volumen.csv';
      a.click();
    }
  </script>
</body>
</html>
