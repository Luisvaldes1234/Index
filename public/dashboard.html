<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Supabase</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
</head>
<body>
  <h1>Dashboard de Ventas</h1>
  <button id="logout">Cerrar Sesión</button>

  <section>
    <h2>Seleccione la Máquina</h2>
    <select id="machine-select">
      <option value="">Todas las máquinas</option>
    </select>
  </section>

  <section>
    <h2>Resumen Financiero</h2>
    <p>Total Hoy: <span id="total-hoy">$0.00</span></p>
    <p>Total Mes: <span id="total-mes">$0.00</span></p>
    <p>Total Año: <span id="total-anio">$0.00</span></p>
  </section>

  <section>
    <h2>Detalle de Ventas</h2>
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Volumen</th>
          <th>Total (MXN)</th>
        </tr>
      </thead>
      <tbody id="ventas-body">
        <!-- Filas generadas dinámicamente -->
      </tbody>
    </table>
  </section>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabaseUrl = 'https://ikuouxllerfjnibjtlkl.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrdW91eGx...';
    const supabase = createClient(supabaseUrl, supabaseKey);

    document.addEventListener('DOMContentLoaded', async () => {
      const logoutBtn = document.getElementById('logout');
      const machineSelect = document.getElementById('machine-select');
      const ventasBody   = document.getElementById('ventas-body');
      const totalHoy     = document.getElementById('total-hoy');
      const totalMes     = document.getElementById('total-mes');
      const totalAnio    = document.getElementById('total-anio');

      // Verificar sesión activa
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (sessionError || !session) {
        window.location.href = 'login.html';
        return;
      }
      const user = session.user;
      console.log('Usuario autenticado:', user.id);

      // Cargar máquinas del usuario
      const { data: machines, error: machinesError } = await supabase
        .from('machines')
        .select('*')
        .eq('owner_id', user.id);
      if (machinesError) {
        console.error('Error cargando máquinas:', machinesError.message);
        return;
      }
      machines.forEach((machine) => {
        const option = document.createElement('option');
        option.value = machine.id;
        option.textContent = machine.name || `Máquina ${machine.id}`;
        machineSelect.appendChild(option);
      });

      machineSelect.addEventListener('change', () => loadSales(machineSelect.value));

      // Función para cargar y mostrar ventas
      async function loadSales(machineId = '') {
        try {
          let query = supabase
            .from('sales')
            .select('*')
            .eq('machine_owner_id', user.id);
          if (machineId) query = query.eq('machine_id', machineId);

          const { data: sales, error: salesError } = await query;
          if (salesError) throw salesError;

          const today        = new Date().toISOString().slice(0, 10);
          const currentMonth = new Date().toISOString().slice(0, 7);
          const currentYear  = new Date().toISOString().slice(0, 4);

          let hoyTotal = 0, mesTotal = 0, anioTotal = 0;
          ventasBody.innerHTML = '';

          sales.forEach((sale) => {
            const isoDate = new Date(sale.created_at).toISOString();
            const total   = Number(sale.total_price || 0);
            const volumen = Number(sale.volume      || 0);

            ventasBody.innerHTML += `
              <tr>
                <td>${isoDate.slice(0, 10)}</td>
                <td>${volumen} L</td>
                <td>$${total.toFixed(2)}</td>
              </tr>`;

            if (isoDate.startsWith(today))        hoyTotal += total;
            if (isoDate.startsWith(currentMonth)) mesTotal += total;
            if (isoDate.startsWith(currentYear))  anioTotal += total;
          });

          totalHoy.textContent  = `$${hoyTotal.toFixed(2)}`;
          totalMes.textContent  = `$${mesTotal.toFixed(2)}`;
          totalAnio.textContent = `$${anioTotal.toFixed(2)}`;
        } catch (err) {
          console.error('Error cargando ventas:', err.message);
          alert('Error cargando ventas: ' + err.message);
        }
      }

      await loadSales();

      // Cerrar sesión
      logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      });
    });
  </script>
</body>
</html>
